// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  //output:@prisma/client
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Benutzer {
  id            Int      @id @default(autoincrement())
  vorname       String   @db.VarChar(255)
  nachname      String   @db.VarChar(255)
  email         String   @unique @db.VarChar(255)
  passwort_hash String   @db.VarChar(255)
  erstellt_am   DateTime @default(now())
  aktiv         Boolean  @default(true)

  benutzer_rollen  BenutzerRolle[]
  benutzer_klassen BenutzerKlasse[]
  benutzer_faecher BenutzerFach[]

  aufgaben_erstellt Aufgabe[] @relation("LehrerAufgaben")
  abgaben           Abgabe[]  @relation("SchuelerAbgaben")
}

model Rolle {
  id           Int     @id @default(autoincrement())
  bezeichnung  String  @unique @db.VarChar(255)
  beschreibung String? @db.Text

  benutzer_rollen BenutzerRolle[]
}

model BenutzerRolle {
  id          Int @id @default(autoincrement())
  benutzer_id Int
  rolle_id    Int

  benutzer Benutzer @relation(fields: [benutzer_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  rolle    Rolle    @relation(fields: [rolle_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([benutzer_id, rolle_id])
  @@map("Benutzer_Rolle")
}

model Klasse {
  id       Int    @id @default(autoincrement())
  name     String @db.VarChar(50)
  jahrgang Int

  benutzer_klassen BenutzerKlasse[]
  aufgaben         Aufgabe[] //Aufgaben der klasse aufgeben, nicht den schülern 

  @@unique([name, jahrgang])
}

model BenutzerKlasse {
  id          Int @id @default(autoincrement())
  benutzer_id Int
  klasse_id   Int

  klasse   Klasse   @relation(fields: [klasse_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  benutzer Benutzer @relation(fields: [benutzer_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([benutzer_id, klasse_id])
  @@map("Benutzer_Klasse")
}

model Fach {
  id      Int    @id @default(autoincrement())
  name    String @db.VarChar(255)
  kuerzel String @unique @db.VarChar(255)

  benutzer_faecher BenutzerFach[]
  aufgaben         Aufgabe[]
}

model BenutzerFach {
  id          Int @id @default(autoincrement())
  benutzer_id Int
  fach_id     Int

  benutzer Benutzer @relation(fields: [benutzer_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  fach     Fach     @relation(fields: [fach_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([benutzer_id, fach_id])
  @@map("Benutzer_Fach")
}

model Aufgabe {
  id           Int      @id @default(autoincrement())
  titel        String   @db.VarChar(255)
  beschreibung String   @db.Text
  anhaenge     String?  @db.Text // JSON 数组存储附件路径
  termin       DateTime
  klasse_id    Int
  fach_id      Int
  lehrer_id    Int
  erstellt_am  DateTime @default(now())

  klasse  Klasse   @relation(fields: [klasse_id], references: [id], onDelete: Cascade) //schüler absovieren--> klasse löschen--> alle aufgaben löschen
  fach    Fach     @relation(fields: [fach_id], references: [id])
  lehrer  Benutzer @relation("LehrerAufgaben", fields: [lehrer_id], references: [id])
  abgaben Abgabe[]

  @@index([klasse_id, termin])
  @@index([lehrer_id])
}

model Abgabe {
  id               Int      @id @default(autoincrement())
  aufgabe_id       Int
  schueler_id      Int
  dateien          String?  @db.Text // JSON 数组存储文件路径
  abgabe_zeitpunkt DateTime @default(now())
  bewertung        Int? // 评分 (0-100)
  feedback         String?  @db.Text

  aufgabe  Aufgabe  @relation(fields: [aufgabe_id], references: [id], onDelete: Cascade)
  schueler Benutzer @relation("SchuelerAbgaben", fields: [schueler_id], references: [id])

  @@unique([aufgabe_id, schueler_id])
  @@index([schueler_id])
}
