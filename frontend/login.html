<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSubmit ‚Äì Login</title>

  <!-- ‚úÖ Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(135deg, #e9f2ff, #f9f9ff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Inter", system-ui, sans-serif;
      position: relative;
    }

    /* üîπ Language switch in page corner / –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ */
    .lang-switch {
      position: fixed;
      top: 1rem;
      right: 1.5rem;
      z-index: 1000;
    }

    .lang-btn {
      border: none;
      background: transparent;
      font-weight: 600;
      color: #4b5a7a;
      margin-left: 0.25rem;
      padding: 0.35rem 0.7rem;
      border-radius: 0.6rem;
      transition: all 0.2s ease;
    }

    .lang-btn:hover { background-color: rgba(75,141,248,0.1); color:#4b8df8; }
    .lang-btn.active { background-color:#4b8df8; color:#fff; }

    /* üîπ Login card / –ö–∞—Ä—Ç–æ—á–∫–∞ –ª–æ–≥–∏–Ω–∞ */
    .login-card {
      width: 100%;
      max-width: 460px;
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      text-align: center;
    }

    .form-control:focus { border-color:#4b8df8; box-shadow:0 0 0 .2rem rgba(75,141,248,.25); }
    .btn-primary { background:#4b8df8; border-color:#4b8df8; border-radius:.75rem; }
    .btn-primary:hover { background:#3a78db; }
  </style>
  <script src="js/login.js" defer></script>

</head>

<body>
  <!-- üîπ Language switch ‚Äî outside the form -->
  <!-- EN: Language buttons on top-right corner of page -->
  <!-- RU: –ö–Ω–æ–ø–∫–∏ —è–∑—ã–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <div class="lang-switch">
    <button id="lang-de" class="lang-btn active">üá©üá™ DE</button>
    <button id="lang-en" class="lang-btn">üá¨üáß EN</button>
  </div>

  <!-- üîπ Login form card -->
  <div class="login-card">
    <h2 id="t-title" class="mb-1">üë§ Login</h2>
    <p id="t-sub" class="text-muted mb-4">Bitte melde dich mit deinem Konto an</p>

    <form id="loginForm">
      <div class="mb-3 text-start">
        <label id="t-email-label" for="email" class="form-label">E-Mail-Adresse</label>
        <input id="email" type="email" class="form-control" placeholder="name@schule.at" required />
      </div>

      <div class="mb-3 text-start">
        <label id="t-pass-label" for="password" class="form-label">Passwort</label>
        <input id="password" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      </div>

      <div class="mb-3 text-start">
        <label id="t-role-label" for="rolleId" class="form-label">Rolle ausw√§hlen</label>
        <select id="rolleId" class="form-select" required></select>
      </div>

      <button type="submit" class="btn btn-primary w-100 mt-2" id="t-login-btn">Einloggen</button>
    </form>

    <div id="msg" class="text-center small mt-3 text-danger" style="min-height:1.25rem"></div>
  </div>

  <script>
    const API_URL = "http://localhost:3000"; 
    // EN: backend base address
    // RU: –±–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å backend-—Å–µ—Ä–≤–µ—Ä–∞

    /* üåç Language dictionary / –°–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ */
    const T = {
      de:{title:"üë§ Login",sub:"Bitte melde dich mit deinem Konto an",email:"E-Mail-Adresse",pass:"Passwort",role:"Rolle ausw√§hlen",login:"Einloggen",errServer:"Server nicht erreichbar.",errCreds:"E-Mail oder Passwort falsch.",errRole:"Keine Berechtigung f√ºr die gew√§hlte Rolle."},
      en:{title:"üë§ Login",sub:"Please sign in with your account",email:"Email address",pass:"Password",role:"Select role",login:"Log in",errServer:"Server unreachable.",errCreds:"Incorrect email or password.",errRole:"You don't have permission for the selected role."}
    };

    // EN: load saved language or default to German
    // RU: –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —è–∑—ã–∫ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –Ω–µ–º–µ—Ü–∫–∏–π
    let lang = localStorage.getItem("lang") || "de";

    // EN: short helpers / RU: –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–º–æ—â–Ω–∏–∫–∏
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    /* --------------------------------------------------
       applyLang()
       EN: Applies current language texts to UI elements.
       RU: –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –∫–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
    -------------------------------------------------- */
    function applyLang(){
      const t=T[lang];
      $("#t-title").textContent=t.title;
      $("#t-sub").textContent=t.sub;
      $("#t-email-label").textContent=t.email;
      $("#t-pass-label").textContent=t.pass;
      $("#t-role-label").textContent=t.role;
      $("#t-login-btn").textContent=t.login;
      $$(".lang-btn").forEach(btn=>btn.classList.toggle("active",btn.id===`lang-${lang}`));
    }

    /* --------------------------------------------------
       Language switch events / –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞
    -------------------------------------------------- */
    $("#lang-de").addEventListener("click",()=>{lang="de";localStorage.setItem("lang","de");applyLang();loadRoles();});
    $("#lang-en").addEventListener("click",()=>{lang="en";localStorage.setItem("lang","en");applyLang();loadRoles();});

    /* --------------------------------------------------
       loadRoles()
       EN: Fetches role list from backend and fills dropdown.
       RU: –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π —Å backend –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫.
    -------------------------------------------------- */
    async function loadRoles(){
      try{
        const res=await fetch(`${API_URL}/api/auth/available-roles`);
        const json=await res.json();
        const select=$("#rolleId");
        select.innerHTML="";
        const labels={de:{Sch√ºler:"Sch√ºler",Lehrer:"Lehrer",Admin:"Admin"},en:{Sch√ºler:"Student",Lehrer:"Teacher",Admin:"Admin"}};
        (json.data||[]).forEach(r=>{
          const opt=document.createElement("option");
          opt.value=r.id;
          opt.textContent=labels[lang][r.bezeichnung]||r.bezeichnung;
          select.appendChild(opt);
        });
      }catch(e){$("#msg").textContent=T[lang].errServer;}
    }

    /* --------------------------------------------------
       Login form submit / –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ª–æ–≥–∏–Ω–∞
       EN: Sends credentials to backend, checks chosen role.
       RU: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω–∞ –Ω–∞ backend, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å.
    -------------------------------------------------- */
    $("#loginForm").addEventListener("submit",async e=>{
      e.preventDefault();
      $("#msg").textContent="";
      const email=$("#email").value.trim();
      const passwort=$("#password").value.trim();
      const selectedRoleId=parseInt($("#rolleId").value);

      try{
        const res=await fetch(`${API_URL}/api/login`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({email,passwort})
        });
        const json=await res.json();
        if(!json.success){$("#msg").textContent=T[lang].errCreds;return;}
        const roles=(json.data?.user?.roles||[]).map(r=>r.id);
        if(!roles.includes(selectedRoleId)){ $("#msg").textContent=T[lang].errRole; return; }

        localStorage.setItem("token",json.data.token);
        localStorage.setItem("userEmail",json.data.user.email);
        localStorage.setItem("roleId",String(selectedRoleId));

        const routeByRole={1:"schueler.html",2:"lehrer.html",3:"admin.html"};
        window.location.href=routeByRole[selectedRoleId]||"startsite.html";
      }catch(err){
        console.error(err);
        $("#msg").textContent=T[lang].errServer;
      }
    });

    /* --------------------------------------------------
       Page init / –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
       EN: On load ‚Üí apply language + load roles.
       RU: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —è–∑—ã–∫ –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–æ–ª–∏.
    -------------------------------------------------- */
    document.addEventListener("DOMContentLoaded",async()=>{
      applyLang();
      await loadRoles();
    });
  </script>
</body>
</html>
