<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSubmit ‚Äì Registrierung</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(135deg, #e9f2ff, #f9f9ff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Inter", sans-serif;
      position: relative;
    }

    .lang-switch {
      position: fixed;
      top: 1rem;
      right: 1.5rem;
      z-index: 1000;
    }

    .lang-btn {
      border: none;
      background: transparent;
      font-weight: 600;
      color: #4b5a7a;
      margin-left: 0.25rem;
      padding: 0.35rem 0.7rem;
      border-radius: 0.6rem;
      transition: all 0.2s ease;
    }

    .lang-btn:hover { background: rgba(75,141,248,0.1); color:#4b8df8; }
    .lang-btn.active { background:#4b8df8; color:#fff; }

    .register-card {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 6px 25px rgba(0,0,0,0.1);
      padding: 2rem;
      text-align: center;
      border-top: 5px solid #4b8df8;
    }

    .register-card h2 { color: #4b8df8; font-weight: 700; margin-bottom: 0.3rem; }
    .form-control:focus { border-color: #4b8df8; box-shadow: 0 0 0 .2rem rgba(75,141,248,.25); }
    .btn-register { background: #34a853; border: none; border-radius: .75rem; font-weight: 500; }
    .btn-register:hover { background: #2c8e45; }
  </style>
</head>

<body>
  <!-- üåê Language switch -->
  <div class="lang-switch">
    <button id="lang-de" class="lang-btn active">üá©üá™ DE</button>
    <button id="lang-en" class="lang-btn">üá¨üáß EN</button>
  </div>

  <!-- üìã Registration card -->
  <div class="register-card">
    <h2 id="t-title">‚ú≥Ô∏è Registrierung</h2>
    <p id="t-sub" class="text-muted mb-4">Bitte erstellen Sie ein neues Konto</p>

    <form id="registerForm">
      <div class="mb-3 text-start">
        <label id="t-email" for="email" class="form-label">E-Mail-Adresse</label>
        <input id="email" type="email" class="form-control" placeholder="name@schule.at" required />
      </div>

      <div class="mb-3 text-start">
        <label id="t-pass" for="password" class="form-label">Passwort</label>
        <input id="password" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      </div>

      <div class="mb-3 text-start">
        <label id="t-role" for="rolleId" class="form-label">Rolle ausw√§hlen</label>
        <select id="rolleId" class="form-select" required></select>
      </div>

      <button type="submit" class="btn btn-register w-100 mt-2" id="t-register-btn">Registrieren</button>
      <p class="small-text mt-3" id="loginLink">
        Schon ein Konto? <a href="login.html">Einloggen</a>
      </p>
    </form>

    <div id="msg" class="text-danger mt-3 small"></div>
  </div>

  <script>
    const API_URL = window.location.origin;

    /* ------------------------------------------------
       T ‚Äî EN: translation dictionary
       RU: —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    ------------------------------------------------ */
    const T = {
      de:{
        title:"‚ú≥Ô∏è Registrierung",
        sub:"Bitte erstellen Sie ein neues Konto",
        email:"E-Mail-Adresse",
        pass:"Passwort",
        role:"Rolle ausw√§hlen",
        register:"Registrieren",
        loginText:"Schon ein Konto?",
        loginLink:"Einloggen",
        errServer:"Server nicht erreichbar",
        regDisabled:"Registrierung ist deaktiviert. Bitte wenden Sie sich an den Administrator."
      },
      en:{
        title:"‚ú≥Ô∏è Registration",
        sub:"Please create a new account",
        email:"Email address",
        pass:"Password",
        role:"Select role",
        register:"Sign up",
        loginText:"Already have an account?",
        loginLink:"Log in",
        errServer:"Server unreachable",
        regDisabled:"Registration is disabled. Please contact the administrator."
      }
    };

    let lang = localStorage.getItem("lang") || "de";
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    /* ------------------------------------------------
       applyLang() ‚Äî EN: update all texts based on selected language
       RU: –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
    ------------------------------------------------ */
    function applyLang(){
      const t = T[lang];
      $("#t-title").textContent = t.title;
      $("#t-sub").textContent = t.sub;
      $("#t-email").textContent = t.email;
      $("#t-pass").textContent = t.pass;
      $("#t-role").textContent = t.role;
      $("#t-register-btn").textContent = t.register;
      $("#loginLink").innerHTML = `${t.loginText} <a href="login.html">${t.loginLink}</a>`;
      $$(".lang-btn").forEach(b => b.classList.toggle("active", b.id === `lang-${lang}`));
    }

    /* ------------------------------------------------
       Language switch ‚Äî EN: change language and reload UI
       RU: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    ------------------------------------------------ */
    $("#lang-de").onclick = () => { lang = "de"; localStorage.setItem("lang","de"); applyLang(); loadRoles(); };
    $("#lang-en").onclick = () => { lang = "en"; localStorage.setItem("lang","en"); applyLang(); loadRoles(); };

    /* ------------------------------------------------
       loadRoles() ‚Äî EN: check if admin exists and show roles accordingly
       RU: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∞–¥–º–∏–Ω, –∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–æ–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
    ------------------------------------------------ */
    async function loadRoles(){
      const select = $("#rolleId");
      select.innerHTML = "";

      try {
        const res = await fetch(`${API_URL}/api/admin/check`);
        const json = await res.json();
        const adminExists = json.adminExists;

        // üîí EN: if admin exists ‚Äî disable registration
        // üîí RU: –µ—Å–ª–∏ –∞–¥–º–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        if (adminExists) {
          $(".register-card").innerHTML = `
            <h2>${T[lang].title}</h2>
            <p class="text-danger mt-3">${T[lang].regDisabled}</p>
            <a href="login.html" class="btn btn-primary mt-3">‚û°Ô∏è ${T[lang].loginLink}</a>
          `;
          return;
        }

        // ‚úÖ EN: no admin yet ‚Äî allow only the Admin role
        // ‚úÖ RU: –µ—Å–ª–∏ –∞–¥–º–∏–Ω–∞ –Ω–µ—Ç ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ —Å —Ä–æ–ª—å—é Admin
        const opt = document.createElement("option");
        opt.value = 3;
        opt.textContent = "Admin";
        select.appendChild(opt);

      } catch (err) {
        console.error("Fehler beim Laden der Rollen:", err);
        $("#msg").textContent = T[lang].errServer;
      }
    }

    /* ------------------------------------------------
       handleSubmit() ‚Äî EN: handle registration form submission
       RU: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    ------------------------------------------------ */
    $("#registerForm").addEventListener("submit", async e => {
      e.preventDefault();
      $("#msg").textContent = "";

      const email = $("#email").value.trim();
      const passwort = $("#password").value.trim();
      const rolleId = parseInt($("#rolleId").value);

      try {
        const res = await fetch(`${API_URL}/api/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, passwort, rolleId })
        });

        if (!res.ok) throw new Error("API fehlt");
        const json = await res.json();
        alert("‚úÖ Registrierung erfolgreich!");
        window.location.href = "login.html";

      } catch (err) {
        console.warn("Kein Backend, Registrierung lokal simuliert:", { email, passwort, rolleId });
        alert("‚öôÔ∏è Backend nicht verf√ºgbar ‚Äì Registrierung simuliert.");
        window.location.href = "login.html";
      }
    });

    /* ------------------------------------------------
       DOMContentLoaded ‚Äî EN: apply language and check for existing admin on page load
       RU: –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –∞–¥–º–∏–Ω
    ------------------------------------------------ */
    document.addEventListener("DOMContentLoaded", async () => {
      applyLang();
      await loadRoles();
    });
  </script>
</body>
</html>
