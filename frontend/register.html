<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartSubmit ‚Äì Registrierung</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(135deg,#e9f2ff,#f9f9ff);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:"Inter",sans-serif;
      position:relative;
    }
    .lang-switch{
      position:fixed;top:1rem;right:1.5rem;z-index:1000;
    }
    .lang-btn{
      border:none;background:transparent;
      font-weight:600;color:#4b5a7a;
      margin-left:0.25rem;padding:0.35rem 0.7rem;
      border-radius:0.6rem;transition:all 0.2s ease;
    }
    .lang-btn:hover{background:rgba(75,141,248,0.1);color:#4b8df8;}
    .lang-btn.active{background:#4b8df8;color:#fff;}
    .register-card{
      width:100%;max-width:420px;background:#fff;
      border-radius:1.5rem;box-shadow:0 6px 25px rgba(0,0,0,0.1);
      padding:2rem;text-align:center;border-top:5px solid #4b8df8;
    }
    .register-card h2{color:#4b8df8;font-weight:700;margin-bottom:0.3rem;}
    .form-control:focus{border-color:#4b8df8;box-shadow:0 0 0 .2rem rgba(75,141,248,.25);}
    .btn-register{background:#34a853;border:none;border-radius:.75rem;font-weight:500;}
    .btn-register:hover{background:#2c8e45;}
  </style>
</head>
<body>
  <!-- üåê language switch / –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
  <div class="lang-switch">
    <button id="lang-de" class="lang-btn active">üá©üá™ DE</button>
    <button id="lang-en" class="lang-btn">üá¨üáß EN</button>
  </div>

  <!-- üìã registration card -->
  <div class="register-card">
    <h2 id="t-title">‚ú≥Ô∏è Registrierung</h2>
    <p id="t-sub" class="text-muted mb-4">Bitte erstellen Sie ein neues Konto</p>

    <form id="registerForm">
      <div class="mb-3 text-start">
        <label id="t-email" for="email" class="form-label">E-Mail-Adresse</label>
        <input id="email" type="email" class="form-control" placeholder="name@schule.at" required />
      </div>

      <div class="mb-3 text-start">
        <label id="t-pass" for="password" class="form-label">Passwort</label>
        <input id="password" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
      </div>

      <div class="mb-3 text-start">
        <label id="t-role" for="rolleId" class="form-label">Rolle ausw√§hlen</label>
        <select id="rolleId" class="form-select" required></select>
      </div>

      <button type="submit" class="btn btn-register w-100 mt-2" id="t-register-btn">Registrieren</button>
      <p class="small-text mt-3" id="loginLink">
        Schon ein Konto? <a href="login.html">Einloggen</a>
      </p>
    </form>

    <div id="msg" class="text-danger mt-3 small"></div>
  </div>

  <script>
    const API_URL = "http://127.0.0.1:3000"; // backend base URL

    /* üåç Translation dictionary / —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ */
    const T={
      de:{title:"‚ú≥Ô∏è Registrierung",sub:"Bitte erstellen Sie ein neues Konto",email:"E-Mail-Adresse",pass:"Passwort",role:"Rolle ausw√§hlen",register:"Registrieren",loginText:"Schon ein Konto?",loginLink:"Einloggen",errServer:"Server nicht erreichbar",errRole:"Admin existiert bereits"},
      en:{title:"‚ú≥Ô∏è Registration",sub:"Please create a new account",email:"Email address",pass:"Password",role:"Select role",register:"Sign up",loginText:"Already have an account?",loginLink:"Log in",errServer:"Server unreachable",errRole:"Admin already exists"}
    };
    let lang=localStorage.getItem("lang")||"de";
    const $=s=>document.querySelector(s); const $$=s=>document.querySelectorAll(s);

    /* ------------------------------------------------
       applyLang() ‚Äî EN: update texts / RU: –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
    ------------------------------------------------ */
    function applyLang(){
      const t=T[lang];
      $("#t-title").textContent=t.title;
      $("#t-sub").textContent=t.sub;
      $("#t-email").textContent=t.email;
      $("#t-pass").textContent=t.pass;
      $("#t-role").textContent=t.role;
      $("#t-register-btn").textContent=t.register;
      $("#loginLink").innerHTML=`${t.loginText} <a href="login.html">${t.loginLink}</a>`;
      $$(".lang-btn").forEach(b=>b.classList.toggle("active",b.id===`lang-${lang}`));
    }

    $("#lang-de").onclick=()=>{lang="de";localStorage.setItem("lang","de");applyLang();loadRoles();};
    $("#lang-en").onclick=()=>{lang="en";localStorage.setItem("lang","en");applyLang();loadRoles();};

    /* ------------------------------------------------
       loadRoles() ‚Äî EN: get available roles
       RU: –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–æ–ª–∏ —Å backend
    ------------------------------------------------ */
    async function loadRoles(){
      try{
        const roleRes=await fetch(`${API_URL}/api/auth/available-roles`);
        const {data}=await roleRes.json();
        const adminCheck=await fetch(`${API_URL}/api/admin/check`);
        const {adminExists}=await adminCheck.json();
        const select=$("#rolleId");
        select.innerHTML="";
        const labels={de:{Sch√ºler:"Sch√ºler",Lehrer:"Lehrer",Admin:"Admin"},en:{Sch√ºler:"Student",Lehrer:"Teacher",Admin:"Admin"}};
        data.forEach(r=>{
          if(r.bezeichnung==="Admin" && adminExists) return; // hide admin if exists
          const opt=document.createElement("option");
          opt.value=r.id; opt.textContent=labels[lang][r.bezeichnung]||r.bezeichnung;
          select.appendChild(opt);
        });
      }catch(e){$("#msg").textContent=T[lang].errServer;}
    }

    /* ------------------------------------------------
       submit handler / –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    ------------------------------------------------ */
    $("#registerForm").addEventListener("submit",async e=>{
      e.preventDefault(); $("#msg").textContent="";
      const email=$("#email").value.trim();
      const passwort=$("#password").value.trim();
      const rolleId=parseInt($("#rolleId").value);

      try{
        const res=await fetch(`${API_URL}/api/register`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({email,passwort,rolleId})
        });
        const json=await res.json();
        if(!json.success){$("#msg").textContent=json.message||T[lang].errRole;return;}
        alert("‚úÖ Registration successful!");
        window.location.href="login.html";
      }catch(err){
        console.error(err);
        $("#msg").textContent=T[lang].errServer;
      }
    });

    document.addEventListener("DOMContentLoaded",async()=>{applyLang();await loadRoles();});
  </script>
</body>
</html>
